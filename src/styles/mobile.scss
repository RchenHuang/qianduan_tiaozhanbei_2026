// 移动端专用样式和工具类
@use './variables.scss' as *;
@use './mixins.scss' as *;

// 移动端视口高度修复
.mobile-viewport-fix {
  @include mobile {
    // 使用CSS自定义属性动态计算视口高度
    --mobile-vh: calc(var(--vh, 1vh) * 100);
    height: var(--mobile-vh);
    min-height: var(--mobile-vh);
  }
}

// 移动端按钮组优化
.mobile-button-group {
  display: flex;
  gap: $spacing-sm;
  
  @include mobile {
    flex-direction: column;
    gap: $spacing-xs;
    
    // 超小屏幕恢复横向但缩小间距
    @media (max-width: 360px) {
      flex-direction: row;
      gap: 6px;
    }
    
    .button {
      @include mobile-button;
      
      // 文字长度适配
      &.long-text {
        @media (max-width: 360px) {
          font-size: 10px;
          padding: 6px 8px;
        }
      }
    }
  }
}

// 移动端文字防换行
.mobile-text-nowrap {
  @include mobile {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }
}

// 移动端触摸优化
.mobile-touch-target {
  @include mobile {
    min-height: 44px; // iOS推荐
    min-width: 44px;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
}

// Android特殊适配
.android-fix {
  // Android Chrome地址栏适配
  @media screen and (max-width: 768px) {
    @supports (-webkit-appearance: none) {
      // WebKit浏览器（包括Android Chrome）
      height: 100vh;
      height: calc(var(--vh, 1vh) * 100);
    }
  }
  
  // Android系统字体缩放适配
  @media screen and (max-width: 768px) {
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
  }
}

// 微信浏览器特殊适配
.wechat-fix {
  // 微信浏览器底部工具栏适配
  @media screen and (max-width: 768px) {
    padding-bottom: env(safe-area-inset-bottom, 0);
    
    // 微信浏览器特殊处理
    @supports (-webkit-touch-callout: none) {
      padding-bottom: calc(env(safe-area-inset-bottom, 0) + 10px);
    }
  }
}

// 现代浏览器视口单位支持检测
@supports (height: 100dvh) {
  .modern-viewport {
    height: 100dvh !important;
    min-height: 100dvh !important;
  }
}

@supports (height: 100svh) {
  .small-viewport {
    height: 100svh !important;
    min-height: 100svh !important;
  }
}

// 移动端模态框优化
.mobile-modal {
  @include mobile {
    // 确保模态框不被虚拟键盘影响
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    height: 100vh; // 回退
    height: 100dvh; // 动态视口
    
    // iOS Safari特殊处理
    @supports (-webkit-appearance: none) and (not (stroke-color: initial)) {
      height: -webkit-fill-available;
    }
  }
}

// 移动端安全区域适配（增强版）
.mobile-safe-area {
  @include mobile {
    padding-top: max(env(safe-area-inset-top), 20px);
    padding-bottom: max(env(safe-area-inset-bottom), 20px);
    padding-left: max(env(safe-area-inset-left), 16px);
    padding-right: max(env(safe-area-inset-right), 16px);
  }
}

// APK 专用安全区域适配
.apk-safe-area {
  // 顶部安全区域（状态栏 + 刘海屏）
  padding-top: env(safe-area-inset-top, 0);
  
  // 底部安全区域（导航栏 + Home Indicator）
  padding-bottom: env(safe-area-inset-bottom, 0);
  
  // 左右安全区域（刘海屏侧边）
  padding-left: env(safe-area-inset-left, 0);
  padding-right: env(safe-area-inset-right, 0);
  
  // APK 环境下的最小安全边距
  @media (display-mode: standalone) {
    padding-top: max(env(safe-area-inset-top), 24px);
    padding-bottom: max(env(safe-area-inset-bottom), 16px);
  }
}

// 全屏模式安全区域
.fullscreen-safe-area {
  // 全屏游戏模式下的安全区域
  @media (display-mode: fullscreen) {
    padding-top: env(safe-area-inset-top, 0);
    padding-bottom: env(safe-area-inset-bottom, 0);
    padding-left: env(safe-area-inset-left, 0);
    padding-right: env(safe-area-inset-right, 0);
  }
}

// 横屏模式安全区域
.landscape-safe-area {
  @media (orientation: landscape) {
    // 横屏时左右安全区域更重要
    padding-left: max(env(safe-area-inset-left), 20px);
    padding-right: max(env(safe-area-inset-right), 20px);
    padding-top: max(env(safe-area-inset-top), 8px);
    padding-bottom: max(env(safe-area-inset-bottom), 8px);
  }
}

// 动态安全区域（根据内容调整）
.dynamic-safe-area {
  // 基础安全区域
  padding: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) 
           env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
  
  // 内容区域最小边距
  @supports (padding: max(0px)) {
    padding-top: max(env(safe-area-inset-top), 16px);
    padding-bottom: max(env(safe-area-inset-bottom), 16px);
    padding-left: max(env(safe-area-inset-left), 16px);
    padding-right: max(env(safe-area-inset-right), 16px);
  }
}

// 固定元素安全区域
.fixed-safe-area {
  // 固定在顶部的元素
  &.fixed-top {
    top: env(safe-area-inset-top, 0);
    padding-left: env(safe-area-inset-left, 0);
    padding-right: env(safe-area-inset-right, 0);
  }
  
  // 固定在底部的元素
  &.fixed-bottom {
    bottom: env(safe-area-inset-bottom, 0);
    padding-left: env(safe-area-inset-left, 0);
    padding-right: env(safe-area-inset-right, 0);
  }
}

// APK 状态栏适配
.apk-status-bar {
  // 透明状态栏适配
  @media (display-mode: standalone) {
    // 确保内容不被状态栏遮挡
    margin-top: env(safe-area-inset-top, 0);
    
    // 深色状态栏文字适配
    @media (prefers-color-scheme: dark) {
      // 深色主题下的状态栏适配
      background: linear-gradient(
        to bottom,
        rgba(15, 15, 30, 0.9) 0%,
        rgba(15, 15, 30, 0.7) 50%,
        transparent 100%
      );
    }
  }
}

// 刘海屏特殊适配
.notch-adaptation {
  // iPhone X 系列刘海屏
  @supports (padding: max(0px)) and (padding: env(safe-area-inset-top)) {
    // 顶部刘海区域
    &.avoid-notch-top {
      padding-top: max(env(safe-area-inset-top), 44px);
    }
    
    // 底部 Home Indicator 区域
    &.avoid-notch-bottom {
      padding-bottom: max(env(safe-area-inset-bottom), 34px);
    }
  }
  
  // Android 刘海屏（水滴屏、挖孔屏）
  @media (display-cutout: constant) {
    padding-top: constant(safe-area-inset-top);
    padding-left: constant(safe-area-inset-left);
    padding-right: constant(safe-area-inset-right);
    padding-bottom: constant(safe-area-inset-bottom);
  }
}

// 游戏模式安全区域
.game-safe-area {
  // 游戏界面的安全区域
  @include mobile {
    // 游戏区域避开安全区域
    margin-top: env(safe-area-inset-top, 0);
    margin-bottom: env(safe-area-inset-bottom, 0);
    margin-left: env(safe-area-inset-left, 0);
    margin-right: env(safe-area-inset-right, 0);
    
    // 游戏控制按钮的安全区域
    .game-controls {
      padding-bottom: max(env(safe-area-inset-bottom), 20px);
    }
    
    // 游戏头部信息的安全区域
    .game-header {
      padding-top: max(env(safe-area-inset-top), 16px);
      padding-left: max(env(safe-area-inset-left), 16px);
      padding-right: max(env(safe-area-inset-right), 16px);
    }
  }
}

// 移动端性能优化
.mobile-performance {
  @include mobile {
    // 硬件加速
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    
    // 优化滚动
    -webkit-overflow-scrolling: touch;
    
    // 减少重绘
    will-change: transform;
    
    // 禁用选择
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    
    // 禁用长按菜单
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
  }
}

// 虚拟键盘适配
.keyboard-adaptive {
  @include mobile {
    // 防止虚拟键盘推动页面布局
    position: relative;
    
    // 固定底部导航栏，防止被键盘推上去
    .fixed-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: $bg-primary;
      
      // 确保在键盘弹出时保持位置
      @supports (bottom: env(keyboard-inset-height)) {
        bottom: 0; // 不跟随键盘移动
      }
      
      // iOS Safari 特殊处理
      @supports (-webkit-appearance: none) {
        // 使用 viewport-fit=cover 时的安全区域
        padding-bottom: env(safe-area-inset-bottom, 0);
      }
    }
    
    // 弹窗内容区域键盘适配
    .popup-keyboard-safe {
      // 弹窗内容不被键盘遮挡
      max-height: calc(100vh - env(keyboard-inset-height, 0px));
      overflow-y: auto;
      
      // 输入框聚焦时的处理
      .input-focused {
        // 确保输入框可见
        scroll-margin-bottom: 100px;
      }
    }
    
    // Vant 弹窗键盘适配
    .van-popup {
      // 底部弹窗键盘适配
      &.van-popup--bottom {
        // 不跟随键盘移动
        bottom: 0 !important;
        
        // 内容区域适配键盘高度
        .popup-content {
          max-height: calc(100vh - env(keyboard-inset-height, 0px) - 100px);
          overflow-y: auto;
        }
      }
    }
  }
}

// 输入框键盘优化
.input-keyboard-fix {
  @include mobile {
    // 输入框聚焦时的优化
    input, textarea {
      &:focus {
        // 防止页面缩放
        font-size: 16px;
        
        // 确保输入框可见
        scroll-margin-top: 100px;
        scroll-margin-bottom: 100px;
      }
    }
    
    // iOS 输入框优化
    @supports (-webkit-appearance: none) {
      input, textarea {
        // 禁用 iOS 默认样式
        -webkit-appearance: none;
        border-radius: 0;
        
        &:focus {
          // iOS 键盘弹出时的处理
          transform: translateY(0);
        }
      }
    }
  }
}