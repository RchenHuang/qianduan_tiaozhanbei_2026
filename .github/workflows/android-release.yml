name: Android Release

on:
  # Tag è§¦å‘ï¼ˆæŽ¨èï¼‰
  push:
    tags:
      - 'android-v*'

  # æ‰‹åŠ¨è§¦å‘ï¼ˆå¯é€‰æŒ‡å®šç‰ˆæœ¬ï¼‰
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚ 1.0.0)ï¼Œç•™ç©ºåˆ™ä»Ž package.json è¯»å–'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸åˆ›å»º Release å’ŒæŽ¨é€ä»£ç 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Build web assets (without CDN)
        run: DISABLE_CDN=true pnpm build

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install required Android SDK components
        run: |
          echo "Installing Android SDK components..."
          sdkmanager \
            "platforms;android-35" \
            "build-tools;34.0.0" \
            "platform-tools" \
            "cmdline-tools;latest"
          yes | sdkmanager --licenses >/dev/null

      - name: Clean project (lightweight)
        run: |
          rm -rf android/.gradle android/build android/app/build
          rm -rf android/capacitor-android android/capacitor-cordova-android-plugins
          pnpm store prune
          chmod +x android/gradlew

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Setup signing and Gradle properties
        run: |
          cd android
          # ä½¿ç”¨ debug keystoreï¼ˆä»…ç”¨äºŽæµ‹è¯•ï¼›ç”Ÿäº§è¯·æ›¿æ¢ä¸ºæ­£å¼å¯†é’¥ï¼‰
          cat >> gradle.properties <<EOF
          MYAPP_RELEASE_STORE_FILE=debug.keystore
          MYAPP_RELEASE_STORE_PASSWORD=android
          MYAPP_RELEASE_KEY_ALIAS=androiddebugkey
          MYAPP_RELEASE_KEY_PASSWORD=android
          org.gradle.jvmargs=-Xmx3g -XX:MaxMetaspaceSize=512m
          org.gradle.daemon=false
          org.gradle.parallel=true
          android.useAndroidX=true
          android.enableJetifier=false
          # âœ… æŠ‘åˆ¶ AGP 8.2.1 å¯¹ compileSdk=35 çš„è­¦å‘Š
          android.suppressUnsupportedCompileSdk=35
          EOF

      - name: Build Android Release
        working-directory: android
        run: ./gradlew assembleRelease --no-daemon --stacktrace

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/android-v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/android-v}"
          else
            # ä»Ž build.gradle è¯»å– Android ç‰ˆæœ¬ä½œä¸º fallback
            VERSION=$(grep 'versionName' android/app/build.gradle | sed 's/.*versionName "\([^"]*\)".*/\1/')
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Build version: $VERSION"

      - name: Rename APK
        run: |
          mkdir -p release
          cp android/app/build/outputs/apk/release/*.apk release/NeuroFlex-v${{ steps.get_version.outputs.VERSION }}.apk

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: android-v${{ steps.get_version.outputs.VERSION }}
          files: release/NeuroFlex-v${{ steps.get_version.outputs.VERSION }}.apk
          name: Android v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## NeuroFlex Android v${{ steps.get_version.outputs.VERSION }}

            ### ä¸‹è½½
            ç‚¹å‡»ä¸‹æ–¹ APK æ–‡ä»¶ä¸‹è½½å®‰è£…

            ### æ›´æ–°å†…å®¹
            - è¯·æŸ¥çœ‹ commit è®°å½•
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update app-version.json
        run: |
          DOWNLOAD_BASE_URL="${{ vars.DOWNLOAD_BASE_URL || 'https://download-neuroflex.061129.xyz' }}"
          mkdir -p public
          cat > public/app-version.json << EOF
          {
            "version": "${{ steps.get_version.outputs.VERSION }}",
            "versionCode": $(node -p "const v='${{ steps.get_version.outputs.VERSION }}'.split('.'); v[0]*10000+v[1]*100+Number(v[2])"),
            "downloadUrl": "${DOWNLOAD_BASE_URL}/android-v${{ steps.get_version.outputs.VERSION }}/NeuroFlex-v${{ steps.get_version.outputs.VERSION }}.apk",
            "githubUrl": "https://github.com/${{ github.repository }}/releases/download/android-v${{ steps.get_version.outputs.VERSION }}/NeuroFlex-v${{ steps.get_version.outputs.VERSION }}.apk",
            "changelog": "ç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }} å‘å¸ƒ",
            "releaseDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Commit app-version.json
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add public/app-version.json
          git diff --cached --quiet || git commit -m "chore: update app-version.json to v${{ steps.get_version.outputs.VERSION }}"
          git push origin HEAD:main